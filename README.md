# MayakInvestigation_LLaVA_FineTuned
2025λ…„ ν•κ³„ ν•κµ­μ •λ³΄κΈ°μ ν•™ν ν•™μ λ€νμ— ν¬κ³ ν• λ…Όλ¬Έμ…λ‹λ‹¤.

# LLaVA 1.6 κΈ°λ° λ§μ•½ λ²”μ£„ μμ‚¬ μ§€μ› λ””μ§€ν„Έ ν¬λ μ‹ μ΄λ―Έμ§€ μλ™ λ¶„λ¥ μ‹μ¤ν…

## π“ κ°μ”

λ³Έ ν”„λ΅μ νΈλ” "LLaVA 1.6(Vision-Language Model) κΈ°λ° λ§μ•½ λ²”μ£„ μμ‚¬ μ§€μ›μ„ μ„ν• λ””μ§€ν„Έ ν¬λ μ‹ μ΄λ―Έμ§€ μλ™ λ¶„λ¥ μ‹μ¤ν… μ—°κµ¬" λ…Όλ¬Έμ— κΈ°μ λ μλ™ λ””μ§€ν„Έ ν¬λ μ‹ μ΄λ―Έμ§€ λ¶„λ¥ μ‹μ¤ν…μ„ κµ¬ν„ν•©λ‹λ‹¤. μ΄ μ‹μ¤ν…μ€ QLoRA κΈ°λ²•μΌλ΅ ν¨μ¨μ μΌλ΅ νμΈνλ‹λ LLaVA 1.6 λΉ„μ „-μ–Έμ–΄ λ¨λΈ(νΉν `llava-hf/llava-v1.6-mistral-7b-hf`)μ„ ν™μ©ν•©λ‹λ‹¤.

μ‹μ¤ν…μ€ λ§μ•½ κ΄€λ ¨ ν¬λ μ‹ μ΄λ―Έμ§€λ¥Ό λ‹¤μκ³Ό κ°™μ€ 4κ°€μ§€ μ‚¬μ „ μ •μλ λ²”μ£Όλ΅ λ¶„λ¥ν•©λ‹λ‹¤:

- **0: κ΄€λ ¨ μ—†μ**
- **1: λ§μ•½ λ€ν™” λ‚΄μ—­ μ‚¬μ§„**
- **2: λ§μ•½ κ±°λ μ¥μ†**
- **3: λ§μ•½ μ›λ³Έ**

μ΄ ν”„λ΅μ νΈμ λ©ν‘λ” λ°©λ€ν• μ–‘μ μ΄λ―Έμ§€ μ¦κ±° λ¶„μ„μ„ μλ™ν™”ν•μ—¬ μμ‚¬ ν¨μ¨μ„±μ„ λ†’μ΄κ³  μμ‚¬κ΄€μ μ—…λ¬΄ λ¶€λ‹΄μ„ μ¤„μ΄λ” κ²ƒμ…λ‹λ‹¤.

## π’» μ‹μ¤ν… κµ¬μ„± μ”μ† λ° μ¤ν¬λ¦½νΈ

λ³Έ ν”„λ΅μ νΈλ” λ‹¤μμ Python μ¤ν¬λ¦½νΈλ΅ κµ¬μ„±λ©λ‹λ‹¤:

1. **`preprocess.py`**:
    - `raw_data` λ””λ ‰ν† λ¦¬μ—μ„ μ›λ³Έ μ΄λ―Έμ§€ μ •λ³΄λ¥Ό μμ§‘ν•©λ‹λ‹¤.
    - λ°μ΄ν„°μ…‹μ„ ν•™μµ(train), κ²€μ¦(validation), ν…μ¤νΈ(test) μ„ΈνΈλ΅ λ¶„ν• ν•©λ‹λ‹¤ (μ•½ 72.25% / 12.75% / 15%).
    - ν•™μµ μ„ΈνΈ λ‚΄μ '2: λ§μ•½ κ±°λ μ¥μ†' μ΄λ―Έμ§€μ— λ€ν•΄ λ°μ΄ν„° λ¶κ· ν• ν•΄μ†λ¥Ό μ„ν•΄ λ°μ΄ν„° μ¦κ°•(Albumentations μ‚¬μ©)μ„ μ μ©ν•©λ‹λ‹¤. μ΄ ν΄λμ¤μ μ›λ³Έ μ΄λ―Έμ§€ λ‹Ή 4κ°μ μƒλ΅μ΄ μ¦κ°• μ΄λ―Έμ§€λ¥Ό μƒμ„±ν•©λ‹λ‹¤.
    - μ²λ¦¬λ λ°μ΄ν„°μ…‹ μ •λ³΄λ¥Ό `data` λ””λ ‰ν† λ¦¬μ— JSON νμΌ(`train_drug_data.json`, `val_drug_data.json`, `test_drug_data.json`)λ΅ μ €μ¥ν•©λ‹λ‹¤.
2. **`train_script.py`**:
    - LLaVA 1.6 λ¨λΈ(`llava-hf/llava-v1.6-mistral-7b-hf`)μ„ QLoRAλ¥Ό μ‚¬μ©ν•μ—¬ νμΈνλ‹ν•©λ‹λ‹¤.
    - `preprocess.py`μ— μν•΄ μƒμ„±λ JSON νμΌλ΅λ¶€ν„° λ°μ΄ν„°λ¥Ό λ΅λ“ν•©λ‹λ‹¤.
    - PyTorch Lightningμ„ μ‚¬μ©ν•μ—¬ ν•™μµ λ£¨ν”„λ¥Ό κµ¬μ„±ν•©λ‹λ‹¤.
    - μ£Όμ” ν•™μµ νλΌλ―Έν„°:
        - μ—ν­(Epochs): 5
        - ν•™μµλ¥ (Learning Rate): 1e-5
        - μ ν¨ λ°°μΉ ν¬κΈ°(Effective Batch Size): 16 (λ°°μΉ ν¬κΈ° 1, κ·Έλλ””μ–ΈνΈ λ„μ  16)
        - μµν‹°λ§μ΄μ €(Optimizer): AdamW
        - μ •λ°€λ„(Precision): bf16 νΌν•© μ •λ°€λ„
        - LoRA `r`: 16, `lora_alpha`: 32, `lora_dropout`: 0.05 (μ°Έκ³ : `r`κ³Ό `lora_alpha` κ°’μ€ λ…Όλ¬Έμ— μ–ΈκΈ‰λ κ°κ° 8κ³Ό 16κ³Ό λ‹¤λ¦…λ‹λ‹¤).
    - νμΈνλ‹λ λ¨λΈ μ²΄ν¬ν¬μΈνΈ λ° μµμΆ… λ¨λΈ/ν”„λ΅μ„Έμ„λ¥Ό `outputs/llava_next_drug_classifier_epochs5` λ””λ ‰ν† λ¦¬μ— μ €μ¥ν•©λ‹λ‹¤.
    - μ²΄ν¬ν¬μΈνΈλ΅λ¶€ν„° ν•™μµμ„ μ¬κ°ν•λ” κΈ°λ¥μ„ ν¬ν•¨ν•©λ‹λ‹¤.
3. **`eval.py`**:
    - **νμΈνλ‹λ LLaVA 1.6 λ¨λΈ**μ μ„±λ¥μ„ ν‰κ°€ν•©λ‹λ‹¤.
    - `FINETUNED_MODEL_PATH`μ— μ§€μ •λ κ²½λ΅(μ: `outputs/llava_next_drug_classifier_epochs5/final_model_checkpoint`)μ—μ„ νμΈνλ‹λ λ¨λΈμ„ λ΅λ“ν•©λ‹λ‹¤.
    - ν…μ¤νΈ λ°μ΄ν„°μ…‹(`data/test_drug_data.json`)μ„ μ‚¬μ©ν•©λ‹λ‹¤.
    - μ •ν™•λ„(accuracy)μ™€ κ°™μ€ ν‰κ°€μ§€ν‘λ¥Ό κ³„μ‚°ν•κ³ , λ¶„λ¥ λ³΄κ³ μ„(classification report) λ° νΌλ™ ν–‰λ ¬(confusion matrix)μ„ μƒμ„±ν•©λ‹λ‹¤.
    - ν‰κ°€ κ²°κ³Ό(μ: νΌλ™ ν–‰λ ¬ μ΄λ―Έμ§€)λ¥Ό `evaluation_results_epochs5` λ””λ ‰ν† λ¦¬μ— μ €μ¥ν•©λ‹λ‹¤.
4. **`vanilla.py`**:
    - νμΈνλ‹λμ§€ μ•μ€ **κΈ°λ³Έ LLaVA 1.6 λ¨λΈ**(`llava-hf/llava-v1.6-mistral-7b-hf`)μ **μ λ΅μƒ·(zero-shot) μ„±λ¥**μ„ ν‰κ°€ν•©λ‹λ‹¤.
    - ν…μ¤νΈ λ°μ΄ν„°μ…‹(`data/test_drug_data.json`)μ„ μ‚¬μ©ν•©λ‹λ‹¤.
    - λ¨λΈμ„ 4λΉ„νΈ μ–‘μν™”ν•μ—¬ λ΅λ“ν•©λ‹λ‹¤.
    - λ¨λΈμ λ‹¤μ† μ¥ν™©ν•  μ μλ” μ¶λ ¥μ„ μ‚¬μ „ μ •μλ ν΄λμ¤ λ μ΄λΈ” μ¤‘ ν•λ‚λ΅ ν•΄μ„ν•κΈ° μ„ν• μ‚¬μ©μ μ •μ νμ‹± ν•¨μ(`parse_llava_zeroshot_output`)λ¥Ό ν¬ν•¨ν•©λ‹λ‹¤.
    - ν‰κ°€μ§€ν‘λ¥Ό κ³„μ‚°ν•κ³  κ²°κ³Όλ¥Ό `evaluation_results_zeroshot` λ””λ ‰ν† λ¦¬μ— μ €μ¥ν•©λ‹λ‹¤.

## π€ μ£Όμ” λ°©λ²•λ΅ 

- **λ¨λΈ**: LLaVA 1.6 (`llava-hf/llava-v1.6-mistral-7b-hf`), `LlavaNextForConditionalGeneration` μ‚¬μ©.
- **νμΈνλ‹**: QLoRA (Quantized Low-Rank Adaptation)λ¥Ό μ‚¬μ©ν•μ—¬ λ‹¨μΌ GPU(λ…Όλ¬Έμ—μ„ NVIDIA A100 80GB μ–ΈκΈ‰λ¨) ν™κ²½μ—μ„ λ©”λ¨λ¦¬ ν¨μ¨μ μΈ νμΈνλ‹ μν–‰.
    - κΈ°λ³Έ λ¨λΈ κ°€μ¤‘μΉλ¥Ό 4λΉ„νΈ(nf4)λ΅ μ–‘μν™”.
    - LoRAλ¥Ό μ–Έμ–΄ λ¨λΈ λ¶€λ¶„μ νΉμ • μ„ ν• λ μ΄μ–΄μ— μ μ©.
- **λ°μ΄ν„°μ…‹**: λ§μ•½ λ²”μ£„ κ΄€λ ¨ ν¬λ μ‹ μ΄λ―Έμ§€λ΅ κµ¬μ„±λ μ‚¬μ©μ μ •μ λ°μ΄ν„°μ…‹, 4κ°€μ§€ λ²”μ£Όλ΅ λ¶„λ¥λ¨. μ‚¬μ©λ μ§λ¬Έ ν”„λ΅¬ν”„νΈ: `"μ΄ μ΄λ―Έμ§€λ” λ‹¤μ μ¤‘ μ–΄λ–¤ μ ν•μ…λ‹κΉ? (0: κ΄€λ ¨ μ—†μ, 1: λ§μ•½ λ€ν™” λ‚΄μ—­ μ‚¬μ§„, 2: λ§μ•½ κ±°λ μ¥μ†, 3: λ§μ•½ μ›λ³Έ)"`
- **λ°μ΄ν„° μ¦κ°•**: μƒλ€μ μΌλ΅ μκ°€ μ μ€ 'λ§μ•½ κ±°λ μ¥μ†' ν΄λμ¤μ— μ μ©ν•μ—¬ λ¨λΈμ μΌλ°ν™” μ„±λ¥ ν–¥μƒ. μ‚¬μ©λ κΈ°λ²•μ—λ” μΆμ° λ°μ „, νμ „, λ°κΈ°/λ€λΉ„ μ΅°μ , λ…Έμ΄μ¦ μ¶”κ°€, λΈ”λ¬ μ²λ¦¬ λ“±μ΄ ν¬ν•¨λ¨.
- **ν‰κ°€**: μ λ΅μƒ· κΈ°λ³Έ λ¨λΈκ³Ό νμΈνλ‹λ λ¨λΈ κ°„μ μ„±λ¥μ„ ν‘μ¤€ λ¶„λ¥ ν‰κ°€μ§€ν‘λ¥Ό μ‚¬μ©ν•μ—¬ λΉ„κµ. λ…Όλ¬Έμ—μ„λ” μ λ΅μƒ· μ•½ 49.6%μ—μ„ νμΈνλ‹ ν›„ 96.34%λ΅ μ •ν™•λ„κ°€ ν¬κ² ν–¥μƒλμ—λ‹¤κ³  λ³΄κ³ λ¨.

## β™οΈ μ„¤μ • λ° μ‹¤ν–‰ λ°©λ²•

1. **ν™κ²½ μ„¤μ •**:
    - ν•„μ”ν• λΌμ΄λΈλ¬λ¦¬(PyTorch, Transformers, PEFT, PyTorch Lightning, Albumentations, scikit-learn, OpenCV λ“±)κ°€ μ„¤μΉλ Python ν™κ²½μ„ κµ¬μ„±ν•©λ‹λ‹¤.
    - ν•„μ”ν• κ²½μ° `TOKENIZERS_PARALLELISM=false` ν™κ²½ λ³€μλ¥Ό μ„¤μ •ν•©λ‹λ‹¤.
2. **λ°μ΄ν„° μ¤€λΉ„**:
    - μ›λ³Έ μ΄λ―Έμ§€ λ°μ΄ν„°λ¥Ό `CLASS_MAPPING`μ— λ”°λΌ `raw_data/` λ‚΄μ ν•μ„ ν΄λ”(μ: `raw_data/0_irrelevant/`, `raw_data/1_chat_history/` λ“±)μ— λ°°μΉν•©λ‹λ‹¤.
    - `python preprocess.py`λ¥Ό μ‹¤ν–‰ν•μ—¬ `data/*.json` νμΌμ„ μƒμ„±ν•©λ‹λ‹¤.
3. **ν•™μµ**:
    - ν•„μ”ν• κ²½μ° `train_script.py` λ‚΄μ `OUTPUT_MODEL_DIR` λ° `RESUME_CKPT_PATH`λ¥Ό μμ •ν•©λ‹λ‹¤.
    - `python train_script.py`λ¥Ό μ‹¤ν–‰ν•μ—¬ λ¨λΈμ„ νμΈνλ‹ν•©λ‹λ‹¤. μ²΄ν¬ν¬μΈνΈλ” μ¶λ ¥ λ””λ ‰ν† λ¦¬μ— μ €μ¥λ©λ‹λ‹¤.
4. **ν‰κ°€**:
    - **νμΈνλ‹λ λ¨λΈ**:
        - `eval.py`μ `FINETUNED_MODEL_PATH`κ°€ ν•™μµλ λ¨λΈ μ²΄ν¬ν¬μΈνΈ(μ: `outputs/llava_next_drug_classifier_epochs5/final_model_checkpoint`)λ¥Ό κ°€λ¦¬ν‚¤λ„λ΅ ν•©λ‹λ‹¤.
        - `python eval.py`λ¥Ό μ‹¤ν–‰ν•©λ‹λ‹¤. κ²°κ³Όλ” `evaluation_results_epochs5`μ— μ €μ¥λ©λ‹λ‹¤.
    - **μ λ΅μƒ· λ¨λΈ**:
        - `python vanilla.py`λ¥Ό μ‹¤ν–‰ν•©λ‹λ‹¤. κ²°κ³Όλ” `evaluation_results_zeroshot`μ— μ €μ¥λ©λ‹λ‹¤.

## π“ μ°Έκ³  μ‚¬ν•­

- μ¤ν¬λ¦½νΈλ“¤μ€ μ €μ κ²½λ΅ λ° λ¨λΈ IDλ΅ κµ¬μ„±λμ–΄ μμµλ‹λ‹¤. μ‚¬μ©μμ ν™κ²½μ— λ§κ² μ μ ν μμ •ν•μ‹­μ‹μ¤.
- `train_script.py`μ LoRA ν•μ΄νΌνλΌλ―Έν„° `r` (16) λ° `lora_alpha` (32)λ” λ…Όλ¬Έμ μ„Έλ¶€ λ°©λ²•λ΅ μ— μ–ΈκΈ‰λ κ°’(κ°κ° 8, 16)κ³Ό λ‹¤λ¦…λ‹λ‹¤.
- matplotlibμΌλ΅ μƒμ„±λ νΌλ™ ν–‰λ ¬μ—μ„ ν•κΈ€ λ μ΄λΈ”μ„ μ¬λ°”λ¥΄κ² ν‘μ‹ν•λ ¤λ©΄ μ‹μ¤ν…μ— μ μ ν• ν•κΈ€ ν°νΈκ°€ μ„¤μΉλμ–΄ μμ–΄μ•Ό ν•©λ‹λ‹¤ (`eval.py` λ° `vanilla.py`μ `set_korean_font` ν•¨μ μ°Έμ΅°).
